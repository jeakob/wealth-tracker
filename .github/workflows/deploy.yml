name: Deploy Read-Only Demo to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Remove backend dependencies
        working-directory: ./frontend
        run: |
          echo "ðŸ—‘ï¸ Removing backend configuration..."
          # Remove any API base URL configurations
          find src -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) -exec sed -i 's|http://localhost:4000||g' {} \;

      - name: Create read-only demo data
        working-directory: ./frontend
        run: |
          echo "ðŸ“ Creating demo data module..."
          mkdir -p src/lib
          
          cat > src/lib/demoData.js << 'DEMO_EOF'
          // Read-only demo data for GitHub Pages
          
          const DEMO_ASSETS = [
            {
              id: '1',
              name: 'Primary Savings Account',
              type: 'Savings Account',
              value: 45000,
              currency: 'GBP',
              icon: 'piggy-bank',
              createdAt: '2024-01-15T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            },
            {
              id: '2',
              name: 'Stocks & Shares ISA',
              type: 'Investment',
              value: 125000,
              currency: 'GBP',
              icon: 'trending-up',
              createdAt: '2024-03-20T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            },
            {
              id: '3',
              name: 'Pension Fund',
              type: 'Pension',
              value: 87500,
              currency: 'GBP',
              icon: 'briefcase',
              createdAt: '2024-02-10T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            },
            {
              id: '4',
              name: 'Emergency Fund',
              type: 'Savings Account',
              value: 15000,
              currency: 'GBP',
              icon: 'shield',
              createdAt: '2024-01-05T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            },
            {
              id: '5',
              name: 'Cryptocurrency Portfolio',
              type: 'Cryptocurrency',
              value: 8500,
              currency: 'GBP',
              icon: 'bitcoin',
              createdAt: '2024-06-15T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            },
            {
              id: '6',
              name: 'Premium Bonds',
              type: 'Investment',
              value: 25000,
              currency: 'GBP',
              icon: 'award',
              createdAt: '2024-04-01T10:00:00.000Z',
              updatedAt: '2024-12-28T10:00:00.000Z'
            }
          ];
          
          // Generate realistic net worth snapshots for the past 12 months
          const generateSnapshots = () => {
            const snapshots = [];
            const now = new Date();
            const baseValue = 306000; // Total of all assets
            
            for (let i = 11; i >= 0; i--) {
              const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
              // Simulate gradual growth with some volatility
              const monthProgress = (11 - i) / 11;
              const growth = monthProgress * 0.15; // 15% growth over the year
              const volatility = (Math.random() - 0.5) * 0.03; // Â±1.5% random variation
              const value = Math.round(baseValue * (0.85 + growth + volatility));
              
              snapshots.push({
                id: 12 - i,
                date: date.toISOString(),
                totalAssets: value,
                totalLiabilities: 0,
                netWorth: value,
                createdAt: date.toISOString(),
                updatedAt: date.toISOString()
              });
            }
            
            return snapshots;
          };
          
          const DEMO_SNAPSHOTS = generateSnapshots();
          
          const DEMO_SETTINGS = {
            currency: 'GBP',
            theme: 'dark',
            locale: 'en-GB'
          };
          
          export { DEMO_ASSETS, DEMO_SNAPSHOTS, DEMO_SETTINGS };
          DEMO_EOF

      - name: Create API interceptor for read-only mode
        working-directory: ./frontend
        run: |
          echo "ðŸ“ Creating read-only API interceptor..."
          
          cat > src/lib/readOnlyInterceptor.js << 'INTERCEPTOR_EOF'
          import { DEMO_ASSETS, DEMO_SNAPSHOTS, DEMO_SETTINGS } from './demoData.js';
          
          // Block any modification attempts
          const READ_ONLY_MESSAGE = 'This is a read-only demo. Data cannot be modified.';
          
          const shouldIntercept = (url) => {
            if (typeof url !== 'string') return false;
            return url.includes('localhost:4000') || 
                   url.includes('/api/') ||
                   url.includes('/assets') ||
                   url.includes('/bankaccounts') ||
                   url.includes('/liabilities') ||
                   url.includes('/settings') ||
                   url.includes('/history') ||
                   url.includes('/net-worth');
          };
          
          const createResponse = (data, status = 200) => ({
            ok: status >= 200 && status < 300,
            status: status,
            statusText: status === 200 ? 'OK' : 'Read Only',
            headers: new Headers({ 'content-type': 'application/json' }),
            json: () => Promise.resolve(data),
            text: () => Promise.resolve(JSON.stringify(data)),
            clone: function() { return createResponse(data, status); }
          });
          
          // Intercept XHR
          const originalXHROpen = XMLHttpRequest.prototype.open;
          const originalXHRSend = XMLHttpRequest.prototype.send;
          
          XMLHttpRequest.prototype.open = function(method, url, ...args) {
            this._method = method;
            this._url = url;
            return originalXHROpen.call(this, method, url, ...args);
          };
          
          XMLHttpRequest.prototype.send = function(body) {
            const url = this._url;
            const method = this._method;
            
            if (shouldIntercept(url)) {
              const handleRequest = () => {
                let response;
                
                // Block all write operations
                if (method === 'POST' || method === 'PUT' || method === 'PATCH' || method === 'DELETE') {
                  response = { error: READ_ONLY_MESSAGE, success: false };
                  console.warn('ðŸ”’', READ_ONLY_MESSAGE);
                } else {
                  // Handle GET requests
                  if (url.includes('/assets') || url.includes('/bankaccounts')) {
                    response = DEMO_ASSETS;
                  } else if (url.includes('/net-worth')) {
                    response = DEMO_SNAPSHOTS;
                  } else if (url.includes('/settings')) {
                    response = DEMO_SETTINGS;
                  } else if (url.includes('/liabilities')) {
                    response = [];
                  } else {
                    response = [];
                  }
                }
                
                const responseText = JSON.stringify(response);
                Object.defineProperty(this, 'status', { value: 200, configurable: true });
                Object.defineProperty(this, 'statusText', { value: 'OK', configurable: true });
                Object.defineProperty(this, 'readyState', { value: 4, configurable: true });
                Object.defineProperty(this, 'responseText', { value: responseText, configurable: true });
                Object.defineProperty(this, 'response', { value: response, configurable: true });
                
                if (this.onreadystatechange) this.onreadystatechange.call(this);
                if (this.onload) this.onload.call(this, new Event('load'));
              };
              
              handleRequest.call(this);
              return;
            }
            
            return originalXHRSend.call(this, body);
          };
          
          // Intercept fetch
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const url = args[0];
            const options = args[1] || {};
            
            if (shouldIntercept(url)) {
              const method = options.method || 'GET';
              
              // Block write operations
              if (method !== 'GET') {
                console.warn('ðŸ”’', READ_ONLY_MESSAGE);
                return Promise.resolve(createResponse({ error: READ_ONLY_MESSAGE, success: false }, 403));
              }
              
              // Handle GET requests
              if (url.includes('/assets') || url.includes('/bankaccounts')) {
                return Promise.resolve(createResponse(DEMO_ASSETS));
              } else if (url.includes('/net-worth')) {
                return Promise.resolve(createResponse(DEMO_SNAPSHOTS));
              } else if (url.includes('/settings')) {
                return Promise.resolve(createResponse(DEMO_SETTINGS));
              } else if (url.includes('/liabilities')) {
                return Promise.resolve(createResponse([]));
              }
              
              return Promise.resolve(createResponse([]));
            }
            
            return originalFetch.apply(this, args);
          };
          
          console.log('ðŸ”’ Read-only demo mode active - all modifications are disabled');
          INTERCEPTOR_EOF

      - name: Inject interceptor
        working-directory: ./frontend
        run: |
          echo "ðŸ” Injecting read-only interceptor..."
          
          ENTRY_FILE=$(find src -maxdepth 1 \( -name "main.*" -o -name "index.*" \) | head -1)
          
          if [ -n "$ENTRY_FILE" ]; then
            echo "import './lib/readOnlyInterceptor.js';" | cat - "$ENTRY_FILE" > temp && mv temp "$ENTRY_FILE"
            echo "âœ… Interceptor injected into $ENTRY_FILE"
          fi

      - name: Update Vite config
        working-directory: ./frontend
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          if [ -f "vite.config.js" ]; then
            CONFIG_FILE="vite.config.js"
          elif [ -f "vite.config.ts" ]; then
            CONFIG_FILE="vite.config.ts"
          else
            cat > vite.config.js << 'VITE_EOF'
          import { defineConfig } from 'vite'
          import react from '@vitejs/plugin-react'
          
          export default defineConfig({
            plugins: [react()],
            base: '/wealth-tracker/',
            build: { outDir: 'build' }
          })
          VITE_EOF
            exit 0
          fi
          
          sed -i "s|base:.*|base: '/$REPO_NAME/',|g" "$CONFIG_FILE" || \
          sed -i "/defineConfig({/a\  base: '/$REPO_NAME/'," "$CONFIG_FILE"

      - name: Build
        working-directory: ./frontend
        run: |
          npm run build
          
          BUILD_DIR="build"
          [ -d "dist" ] && BUILD_DIR="dist"
          
          # Add 404.html for SPA routing
          cp "$BUILD_DIR/index.html" "$BUILD_DIR/404.html"
          
          # Add read-only banner
          BANNER='<body><div style="background:#dc2626;color:white;padding:8px;text-align:center;font-size:14px;font-weight:600;">ðŸ”’ READ-ONLY DEMO â€¢ Data cannot be saved â€¢ <a href="https://github.com/${{ github.repository }}" style="color:#fef2f2;text-decoration:underline">View Source</a></div>'
          
          sed -i "s|<body>|$BANNER|" "$BUILD_DIR/index.html"
          sed -i "s|<body>|$BANNER|" "$BUILD_DIR/404.html"
          
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/${{ env.BUILD_DIR }}'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
